name: RDP with Fixed Premium Credentials
on: 
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'  # ุฅุนุงุฏุฉ ุชุดุบูู ูููู ุงูุณุงุนุฉ 4 ุตุจุงุญุงู

jobs:
  premium-rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 259200

    steps:
    - name: Configure Premium RDP Settings
      run: |
        # ุชูููู RDP ูุน ุฅุนุฏุงุฏุงุช ูุชูุฏูุฉ
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        
        # ุชุญุณูู ุฅุนุฏุงุฏุงุช ุงูุฃุฏุงุก ูุฌูุฏุฉ ุงูุงุชุตุงู
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fSingleSessionPerUser" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxInstanceCount" -Value 2 -Force
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxMonitors" -Value 4 -Force
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxXResolution" -Value 3840 -Force
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxYResolution" -Value 2160 -Force
        
        # ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุงุฆุท ุงููุชุนุฏุฏุฉ
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "AVC444ModePreferred" -Value 1 -Force
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "AVCHardwareEncodePreferred" -Value 1 -Force
        
        # ูุชุญ ูููุฐ RDP ูู ุงูุฌุฏุงุฑ ุงููุงุฑู
        netsh advfirewall firewall add rule name="RDP Premium" dir=in action=allow protocol=TCP localport=3389 profile=any enable=yes
        
        # ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุฉ
        Restart-Service -Name TermService -Force
        Start-Sleep -Seconds 5
        Write-Host "โ ุชู ุชูููู ุฅุนุฏุงุฏุงุช RDP ุงููุชูุฏูุฉ"

    - name: Create Premium User Account
      run: |
        $username = "abdalli"
        $password = "abdalli@100"
        
        # ุฅูุดุงุก ุฃู ุชุญุฏูุซ ุงููุณุชุฎุฏู
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        $userExists = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
        
        if (-not $userExists) {
          # ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -Description "Premium RDP User"
          Write-Host "โ ุชู ุฅูุดุงุก ุงููุณุชุฎุฏู: $username"
        } else {
          # ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ ูููุณุชุฎุฏู ุงูููุฌูุฏ
          Set-LocalUser -Name $username -Password $securePass -PasswordNeverExpires $true
          Write-Host "โ ุชู ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ ูููุณุชุฎุฏู: $username"
        }
        
        # ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูู ุงููุฌููุนุงุช ุงููุทููุจุฉ
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
        
        # ุชูููู ุงููุณุชุฎุฏู ุฅุฐุง ูุงู ูุนุทูุงู
        Enable-LocalUser -Name $username
        
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        
        Write-Host "โ ุจูุงูุงุช ุงูุงุนุชูุงุฏ ุงูุซุงุจุชุฉ ุฌุงูุฒุฉ: $username / $password"

    - name: Install System Enhancements
      run: |
        # ุชุซุจูุช Chocolatey ุฃููุงู ุฅุฐุง ูู ููู ูุซุจุชุงู
        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }
        
        # ุชุซุจูุช ูุชุตูุญ Chrome ูุงุฎุชุจุงุฑ ุงูููุจ
        $chromeUrl = "https://dl.google.com/chrome/install/latest/chrome_installer.exe"
        $chromePath = "$env:TEMP\chrome_installer.exe"
        Invoke-WebRequest -Uri $chromeUrl -OutFile $chromePath
        Start-Process -FilePath $chromePath -ArgumentList "/silent", "/install" -Wait
        Remove-Item $chromePath -Force
        
        # ุชุซุจูุช ุฃุฏูุงุช ุชุทููุฑ ุฅุถุงููุฉ
        choco install vscode -y --no-progress
        choco install git -y --no-progress
        choco install nodejs -y --no-progress
        
        Write-Host "โ ุชู ุชุซุจูุช ุงูุชุญุณููุงุช ุงูุฅุถุงููุฉ"

    - name: Customize Desktop Experience
      run: |
        # ุชุบููุฑ ุฎูููุฉ ุณุทุญ ุงูููุชุจ
        $wallpaperUrl = "https://raw.githubusercontent.com/sys9k/winwall/main/win11.jpg"
        $wallpaperPath = "$env:TEMP\wallpaper.jpg"
        try {
          Invoke-WebRequest -Uri $wallpaperUrl -OutFile $wallpaperPath -ErrorAction Stop
          
          # ุชุนููู ุงูุฎูููุฉ
          Add-Type -TypeDefinition @"
          using System;
          using System.Runtime.InteropServices;
          using Microsoft.Win32;
          namespace Wallpaper
          {
            public enum Style : int
            {
              Tile, Center, Stretch, Fill, Fit, Span
            }
            public class Setter {
              public const int SetDesktopWallpaper = 20;
              public const int UpdateIniFile = 0x01;
              public const int SendWinIniChange = 0x02;
              [DllImport("user32.dll", SetLastError = true, CharSet = CharSet.Auto)]
              private static extern int SystemParametersInfo (int uAction, int uParam, string lpvParam, int fuWinIni);
              public static void SetWallpaper ( string path, Style style ) {
                SystemParametersInfo( SetDesktopWallpaper, 0, path, UpdateIniFile | SendWinIniChange );
                RegistryKey key = Registry.CurrentUser.OpenSubKey("Control Panel\\Desktop", true);
                switch( style )
                {
                  case Style.Tile:
                    key.SetValue(@"WallpaperStyle", "0") ;
                    key.SetValue(@"TileWallpaper", "1") ;
                    break;
                  case Style.Center:
                    key.SetValue(@"WallpaperStyle", "0") ;
                    key.SetValue(@"TileWallpaper", "0") ;
                    break;
                  case Style.Stretch:
                    key.SetValue(@"WallpaperStyle", "2") ;
                    key.SetValue(@"TileWallpaper", "0") ;
                    break;
                  case Style.Fill:
                    key.SetValue(@"WallpaperStyle", "10") ;
                    key.SetValue(@"TileWallpaper", "0") ;
                    break;
                  case Style.Fit:
                    key.SetValue(@"WallpaperStyle", "6") ;
                    key.SetValue(@"TileWallpaper", "0") ;
                    break;
                  case Style.Span:
                    key.SetValue(@"WallpaperStyle", "22") ;
                    key.SetValue(@"TileWallpaper", "0") ;
                    break;
                }
                key.Close();
              }
            }
          }
"@
          [Wallpaper.Setter]::SetWallpaper( $wallpaperPath, [Wallpaper.Style]::Fill )
          Write-Host "โ ุชู ุชุนููู ุฎูููุฉ ุณุทุญ ุงูููุชุจ ุงููุฎุตุตุฉ"
        } catch {
          Write-Host "โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูุฎูููุฉ ุงููุฎุตุตุฉุ ุงุณุชุฎุฏุงู ุงูุฎูููุฉ ุงูุงูุชุฑุงุถูุฉ"
        }
        
        # ุชุญุณูู ุฅุนุฏุงุฏุงุช ุงูุทุงูุฉ ูููุน ุงูุณุจุงุช
        powercfg -change -monitor-timeout-ac 0
        powercfg -change -standby-timeout-ac 0
        powercfg -change -hibernate-timeout-ac 0
        powercfg -h off
        
        Write-Host "โ ุชู ุชุฎุตูุต ุชุฌุฑุจุฉ ุณุทุญ ุงูููุชุจ"

    - name: Install and Configure Tailscale
      run: |
        # ุชุซุจูุช Tailscale
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        Remove-Item $installerPath -Force
        Start-Sleep -Seconds 10

        # ุงูุงุชุตุงู ุจุดุจูุฉ Tailscale
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=abdalli-premium-rdp --reset --advertise-exit-node
        
        # ุงูุญุตูู ุนูู IP
        $tsIP = $null
        $retries = 0
        while (-not $tsIP -and $retries -lt 15) {
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if (-not $tsIP) {
            Start-Sleep -Seconds 2
            $retries++
          }
        }
        
        if (-not $tsIP) {
          # ูุญุงููุฉ ุทุฑููุฉ ุจุฏููุฉ
          $statusOutput = & "$env:ProgramFiles\Tailscale\tailscale.exe" status
          if ($statusOutput -match '(\d+\.\d+\.\d+\.\d+)') {
            $tsIP = $matches[1]
          } else {
            # ุงุณุชุฎุฏุงู IP ุงูุชุฑุงุถู ูุดุจูุฉ Tailscale
            $tsIP = "100.64.0.1"
          }
        }
        
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
        Write-Host "โ ุนููุงู Tailscale IP: $tsIP"

    - name: Final Verification and Optimization
      run: |
        # ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ุตุงูุญ ููุงุณุชุฎุฏุงู
        $user = Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue
        if (-not $user) {
          Write-Error "โ ุงููุณุชุฎุฏู $env:RDP_USERNAME ุบูุฑ ููุฌูุฏ!"
          exit 1
        }
        
        if (-not $user.Enabled) {
          Enable-LocalUser -Name $env:RDP_USERNAME
          Write-Host "โ ุชู ุชูููู ุงููุณุชุฎุฏู: $env:RDP_USERNAME"
        }
        
        # ุงุฎุชุจุงุฑ ูููุฐ RDP
        $rdpPortOpen = Test-NetConnection -ComputerName 127.0.0.1 -Port 3389 -InformationLevel Quiet
        Write-Host "โ ูููุฐ RDP ููุชูุญ: $rdpPortOpen"
        
        # ุชุญุณูู ุฃุฏุงุก ุงููุธุงู
        try {
          Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All -NoRestart -ErrorAction SilentlyContinue
          Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -NoRestart -ErrorAction SilentlyContinue
        } catch {
          Write-Host "โ๏ธ ุจุนุถ ุงูููุฒุงุช ุงูุฅุถุงููุฉ ุบูุฑ ูุชููุฑุฉ ูู ูุฐุง ุงูุฅุตุฏุงุฑ"
        }
        
        Write-Host "โ ุงููุณุชุฎุฏู $env:RDP_USERNAME ุฌุงูุฒ ูุงุชุตุงูุงุช RDP"

    - name: Display Premium Connection Information
      run: |
        $border = "โ"
        $topLine = "โ" + ($border * 58) + "โ"
        $bottomLine = "โ" + ($border * 58) + "โ"
        $divider = "โ" + ($border * 58) + "โฃ"
        
        Write-Host ""
        Write-Host $topLine
        Write-Host "โ                  ๐ ุงุชุตุงู RDP ูููุฒ ุฌุงูุฒ                 โ"
        Write-Host $divider
        Write-Host "โ   ๐ ุนููุงู IP: $($env:TAILSCALE_IP.PadRight(37)) โ"
        Write-Host "โ   ๐ค ุงุณู ุงููุณุชุฎุฏู: $($env:RDP_USERNAME.PadRight(35)) โ"
        Write-Host "โ   ๐ ูููุฉ ุงููุฑูุฑ: $($env:RDP_PASSWORD.PadRight(35)) โ"
        Write-Host $divider
        Write-Host "โ   ๐ ุจูุงูุงุช ุงุนุชูุงุฏ ุซุงุจุชุฉ - ููุณูุง ุฏุงุฆูุงู                โ"
        Write-Host "โ   ๐จ ุฎูููุฉ ูุฎุตุตุฉ ูุญุณูุฉ ููุชุฌุฑุจุฉ                         โ"
        Write-Host "โ   ๐ ุฅุนุงุฏุฉ ุชุดุบูู ุชููุงุฆู ูููู ุงูุณุงุนุฉ 4 ุตุจุงุญุงู           โ"
        Write-Host "โ   โก ุฃุฏุงุก ูุนุฒุฒ ูุฌูุฏุฉ ุงุชุตุงู ูุงุฆูุฉ                       โ"
        Write-Host $bottomLine
        Write-Host ""
        Write-Host "๐ก ุงุญูุธ ูุฐู ุงููุนูููุงุช ูุงุณุชุฎุฏุงููุง ูู ุงูุงุชุตุงูุงุช ุงููุณุชูุจููุฉ!"
        Write-Host ""

    - name: Maintain Premium Connection
      run: |
        # ุฅูุดุงุก ููู ูุนูููุงุช ุนูู ุณุทุญ ุงูููุชุจ
        $desktopPath = [Environment]::GetFolderPath("Desktop")
        $infoFile = "$desktopPath\ุงุชุตุงู_RDP_ูุนูููุงุช.txt"
        $infoContent = @"
ูุนูููุงุช ุงุชุตุงู RDP ุงููููุฒ
=========================

๐ ุนููุงู IP: $env:TAILSCALE_IP
๐ค ุงุณู ุงููุณุชุฎุฏู: $env:RDP_USERNAME
๐ ูููุฉ ุงููุฑูุฑ: $env:RDP_PASSWORD

โฐ ูุฏุฉ ุงูุชุดุบูู: 3 ุฃูุงู (ุฅุนุงุฏุฉ ุชุดุบูู ุชููุงุฆู)
๐จ ุฎูููุฉ ูุฎุตุตุฉ ูุญุณูุฉ
โก ุฃุฏุงุก ูุนุฒุฒ ูุฌูุฏุฉ ุงุชุตุงู ูุงุฆูุฉ

๐ก ุชู ุฅูุดุงุก ูุฐุง ุงูุงุชุตุงู ุนุจุฑ GitHub Actions
"@
        Set-Content -Path $infoFile -Value $infoContent -Encoding UTF8
        
        Write-Host "๐ ุงุชุตุงู RDP ุงููููุฒ ูุนูู ุงูุขู!"
        Write-Host "๐ IP: $env:TAILSCALE_IP"
        Write-Host "๐ค ุงููุณุชุฎุฏู: $env:RDP_USERNAME"
        Write-Host "๐ ูููุฉ ุงููุฑูุฑ: $env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "๐ป ุชู ุชุซุจูุช: Chrome, VSCode, Git, Node.js"
        Write-Host "๐จ ุชู ุชุนููู ุฎูููุฉ ูุฎุตุตุฉ ูุณุทุญ ุงูููุชุจ"
        Write-Host ""
        Write-Host "โฐ ุงุถุบุท ุนูู Ctrl+C ูู GitHub ูุฅููุงู ุงูุฌูุณุฉ"
        
        # ุญููุฉ ููุญูุงุธ ุนูู ุงูุงุชุตุงู ูุน ุชุญุฏูุซุงุช ุฏูุฑูุฉ
        $counter = 0
        while ($true) {
          $counter++
          if ($counter % 180 -eq 0) {  # ูู 30 ุฏูููุฉ
            Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] RDP ูุดุท - IP: $env:TAILSCALE_IP"
            
            # ุงูุชุญูู ูู ุฃู Tailscale ูุง ูุฒุงู ูุดุทุงู
            $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status
            if ($LASTEXITCODE -ne 0) {
              Write-Host "โ๏ธ ุฅุนุงุฏุฉ ุชูุตูู Tailscale..."
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --reset
            }
          }
          Start-Sleep -Seconds 10
        }
